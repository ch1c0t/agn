// Generated by CoffeeScript 2.5.1
(function() {
  var CWD, Client, PREVIOUS_DEPENDENCIES, SOURCES, Server, YAML, build, chokidar, ensureDirExists, exec, fs, getSources, installPackages, installPackagesIfNeeded, isNotEqual, nodemon, path, printHelp, watch;

  fs = require('fs');

  path = require('path');

  YAML = require('yaml');

  chokidar = require('chokidar');

  nodemon = require('nodemon');

  require('./ext');

  ({Client} = require('./client'));

  ({Server} = require('./server'));

  ({ensureDirExists, isNotEqual} = require('./util'));

  CWD = process.cwd();

  SOURCES = {};

  PREVIOUS_DEPENDENCIES = {};

  exports.run = function() {
    var _agn, _node, command;
    [_node, _agn, command] = process.argv;
    switch (command) {
      case 'build':
        return build();
      case 'watch':
        return watch();
      default:
        return printHelp();
    }
  };

  build = function() {
    var dir;
    dir = `${CWD}/build`;
    ensureDirExists(dir);
    SOURCES = getSources();
    Server(SOURCES)(`${dir}/server`);
    return Client(SOURCES)(`${dir}/client`);
  };

  watch = function() {
    var ref, watcher;
    chokidar.watch('build/server/package.json').on('change', installPackagesIfNeeded);
    build();
    PREVIOUS_DEPENDENCIES = (ref = SOURCES.api.server) != null ? ref.dependencies : void 0;
    installPackages();
    watcher = chokidar.watch(['api.yml', 'functions/**/*.coffee'], {
      persistent: true,
      ignoreInitial: true
    });
    watcher.on('all', function(event, path) {
      console.log(event, path);
      return build();
    });
    return nodemon({
      script: 'build/server/server.js'
    });
  };

  ({exec} = require('child_process'));

  installPackages = function() {
    console.log('installPackages');
    return exec('npm install', {
      cwd: `${CWD}/build/server`
    });
  };

  installPackagesIfNeeded = function(path) {
    var currentDependencies, ref;
    console.log('change', path);
    if (currentDependencies = (ref = SOURCES.api.server) != null ? ref.dependencies : void 0) {
      if (isNotEqual(currentDependencies, PREVIOUS_DEPENDENCIES)) {
        installPackages();
        return PREVIOUS_DEPENDENCIES = currentDependencies;
      }
    }
  };

  getSources = function() {
    var api, auth, functions, i, key, len, name, ref, verify;
    name = path.basename(CWD);
    api = YAML.parse(fs.readFileSync(`${CWD}/api.yml`, 'utf-8'));
    functions = {};
    ref = Object.keys(api.functions);
    for (i = 0, len = ref.length; i < len; i++) {
      key = ref[i];
      functions[key] = fs.readFileSync(`${CWD}/functions/${key}.coffee`, 'utf-8');
    }
    verify = `${CWD}/auth/verifyToken.coffee`;
    if (fs.existsSync(verify)) {
      auth = fs.readFileSync(verify, 'utf-8');
    }
    return {name, api, functions, auth};
  };

  printHelp = function() {
    return console.log('printHelp');
  };

}).call(this);
