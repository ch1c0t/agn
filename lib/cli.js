// Generated by CoffeeScript 2.5.1
(function() {
  var Client, Server, YAML, build, chokidar, cwd, ensureDirExists, fs, getSources, path, printHelp;

  fs = require('fs');

  path = require('path');

  YAML = require('yaml');

  chokidar = require('chokidar');

  require('./ext');

  ({Client} = require('./client'));

  ({Server} = require('./server'));

  ({ensureDirExists} = require('./util'));

  cwd = process.cwd();

  exports.run = function() {
    var _agn, _node, command, watcher;
    [_node, _agn, command] = process.argv;
    switch (command) {
      case 'build':
        return build();
      case 'watch':
        build();
        watcher = chokidar.watch(['api.yml', 'functions/**/*.coffee'], {
          persistent: true
        });
        return watcher.on('all', function(event, path) {
          return console.log(event, path);
        }).on('change', function(path) {
          return build();
        }).on('add', function(path) {});
      default:
        return printHelp();
    }
  };

  build = function() {
    var dir, sources;
    dir = `${cwd}/build`;
    ensureDirExists(dir);
    sources = getSources();
    Server(sources)(`${dir}/server`);
    return Client(sources)(`${dir}/client`);
  };

  getSources = function() {
    var api, functions, i, key, len, name, ref;
    name = path.basename(cwd);
    api = YAML.parse(fs.readFileSync(`${cwd}/api.yml`, 'utf-8'));
    functions = {};
    ref = Object.keys(api.functions);
    for (i = 0, len = ref.length; i < len; i++) {
      key = ref[i];
      functions[key] = fs.readFileSync(`${cwd}/functions/${key}.coffee`, 'utf-8');
    }
    return {name, api, functions};
  };

  printHelp = function() {
    return console.log('printHelp');
  };

}).call(this);
